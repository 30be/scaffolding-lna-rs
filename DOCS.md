# Документация разработчика

## Архитектура
Проект построен по принципу "Lean Rust" - минимум тяжелых зависимостей.

### Основные модули

#### `src/main.rs`
Точка входа. Реализует паттерн "ленивой инициализации":
1. Проверяет наличие `data/antibodies.db`.
2. Если базы нет, запускает `download::populate_db`.
3. Запускает `process::process_all` для обработки новых записей.
4. Выполняет команду `match`.

#### `src/db.rs`
Обертка над `rusqlite`.
- **Schema**:
    - `antibodies`: Основная таблица. Хранит PDB контент в BLOB (сжатие можно добавить позже) и метаданные.
    - `processed`: Флаг завершения обработки.

#### `src/download.rs`
Загрузка данных.
- Использует `ureq` (синхронный HTTP клиент).
- `rayon` для параллельной загрузки PDB файлов.
- Обрабатывает `429 Too Many Requests` с простым backoff.

#### `src/process.rs`
Конвейер обработки.
- **Numbering**: Использует `ANARCII` из локального `.venv`. Модель загружается автоматически при первом запуске.

#### `src/match_ab.rs`
Логика поиска и сопоставления антител.
- **Вход**: Путь к целевому PDB файлу.
- **Процесс**: 
    1. Парсинг целевого PDB.
    2. Извлечение всех "обработанных" записей из SQLite.
    3. Параллельный расчет метрики сходства (Score) для каждого кандидата.
- **Метрики**: В текущей версии (MVP) используется RMSD (Root-Mean-Square Deviation) по первым 50 атомам структур. Чем выше Score, тем ближе структуры.
- **Выход**: JSON-массив из топ-10 совпадений, отсортированный по убыванию Score.

## Расширение
Для улучшения метрик:
1. Доработайте `src/analysis.rs`, добавив алгоритм Kabsch для наложения структур.
2. Используйте результаты нумерации для выбора атомов при сравнении (вместо физической очистки файлов).